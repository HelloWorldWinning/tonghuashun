##同花顺v16 _,5只股票,1天条件

import tushare as ts
import numpy as np
import pandas as pd
import datetime
import time
from multiprocessing import Pool
from multiprocessing.dummy import Pool as ThreadPool

class MarketEma(object):
    def __init__(self,today=datetime.date.today().strftime('%Y-%m-%d')):
        self._temp_stock_pool=['603331', '300671', '601011', '603617', '002497', '300398', '600103', '300479', '002161', '002813', '300656', '002881', '300450', '300669', '300663', '002877', '603286', '603133', '603801', '603335', '601878', '300666', '300662', '300609', '002590', '002455', '000912', '300618', '300670', '300127', '002886', '002885', '002753', '300633', '603938', '300248', '000916', '300306', '600291', '600516', '603799', '300659', '603180', '600936', '002712', '601336', '600191', '002655', '603993', '603638', '002876', '603496', '300531', '603505', '300224', '002830', '000627', '002847', '000016', '300579', '002869', '002234', '603081', '600336', '300525', '300434', '002034', '000530', '300447', '603696', '603906', '300409', '600728', '002460', '000807', '600966', '603196', '600872', '300176', '600776', '300432', '601965', '000510', '603316', '002236', '601318', '002530', '002009', '002050', '000948', '600740', '000410', '002842', '600265', '002017', '600753', '600549', '002340', '300375', '300643', '002810', '300115', '002543', '002142', '603077', '002193', '000933', '002824', '002458', '000970', '600563', '300035', '600477', '002861', '603383', '000717', '603855', '300128', '601636', '603060', '300112', '002079', '002759', '601601', '002466', '600800', '300655', '600226', '300647', '601595', '300496', '002179', '300073', '002488', '002284', '600816', '300400', '002604', '300317', '603000', '300212', '300050', '603389', '603089', '601137', '300205', '002136', '600110', '300632', '600036', '002812', '300591', '600711', '000063', '603816', '300568', '300416', '300665', '002635', '002212', '300091', '600409', '603826', '601020', '300356', '600767', '002691', '603879', '002835', '300037', '300319', '002715', '002799', '603728', '300588', '300648', '300074', '002748', '002695', '000333', '600581', '002302', '002510', '600552', '603069', '600497', '002232', '002614', '002061', '601225', '000928', '002863', '002609', '603226', '601600', '300566', '300162', '600595', '600713', '603232', '603330', '300047', '002108', '300514', '002664', '300474', '000090', '002104', '002008', '300592', '002465', '000612', '002341', '000617', '300309', '600980', '603618', '600346', '603555', '002067', '002194', '603488', '300653', '300493', '300590', '603633', '000651', '300142', '600480', '600113', '603159', '002402', '603026', '600406', '002512', '002738', '300477', '603085', '600742', '002858', '000488', '600567', '002484', '300451', '300261', '000066', '002537', '002139', '300330', '000688', '600308', '002291', '603668', '300359', '000909', '002078', '300116', '603567', '300301', '000028', '600503', '603042', '600459', '002250', '000878', '600356', '603345', '300403', '300357', '000002', '002368', '600996', '600133', '300652', '300537', '300667', '002318', '002403', '002868', '300607', '300013', '600560', '300556', '600383', '600288', '300578', '002853', '002878', '000692', '000762', '603086', '000701', '600330', '300651', '000687', '002268', '002491', '300102', '002439', '603660', '300641', '300323', '300576', '300620', '002545', '600362', '002362', '600796', '300554', '603611', '600351', '603877', '603536', '600350', '002717', '601689', '002261', '300533', '000150', '000795', '300621', '000548', '603456', '600521', '300565', '002382', '000851', '601678', '300552', '600830', '300593', '600986', '600998', '600183', '000009', '300608', '300077', '002294', '600176', '000758', '603041', '300629', '000584', '300197', '002226', '600856', '000728', '300571', '000665', '600909', '601168', '300637', '300401', '002480', '300550', '300661', '600125', '600076', '601958', '600188', '603050', '603758', '300615', '300650', '002412', '300024', '002855', '601212', '601800', '600056', '603200', '600452', '002508', '002171', '300502', '002271', '300559', '300536', '002126', '002631', '600694', '600573', '002044', '300606', '601858', '002628', '002082', '002773', '600586', '002837', '002105', '000899', '000019', '002176', '000502', '600258', '600321', '002378', '300368', '600132', '300622', '002698', '603926', '603955', '601101', '600939', '300097', '600345', '002636', '000861', '603113', '603985', '603797', '000501', '002444', '002883', '300228', '002160', '603269', '002148', '600260', '002536', '603920', '603178', '601628', '000545', '002106', '002197', '002555', '000661', '300419', '000831', '000538', '603360', '002471', '000901', '300638', '300421', '600981', '002577', '002550', '300562', '002068', '603823', '600367', '603600', '000751', '300626', '300449', '002241', '300640', '002703', '300311', '603036', '300563', '002534', '002719', '300532', '000568', '002092', '603637', '000615', '002492', '300596', '002054', '002039', '300158', '000413', '601500', '603018', '000507', '002056', '300438', '603311', '300331', '002448', '300597', '601607', '600104', '600961', '600839', '600630', '002419', '002730', '300270', '002870', '002196', '000022', '300184', '300083', '600392', '600751', '002211', '300207', '000404', '600111', '000752', '300018', '000708', '603738', '603667', '300213', '603009', '600798', '002309', '002871', '603580', '300094', '600082', '300515', '000921', '002452', '300580', '002209', '600676', '300598', '600251', '002240', '603960', '300245', '603538', '300386', '300136', '300053', '300430', '002057', '600175', '002774', '002037', '000638', '300280', '000666', '002816', '300534', '000023', '300631', '600519', '300540', '300244', '603868', '603665', '002311', '300619', '000710', '600398', '000060', '300023', '002415', '600612', '603803', '002101', '603298', '002479', '002307', '603169', '002827', '000599', '600395', '600071', '600582', '002833', '603337', '002872', '600566', '002783', '600783', '300546', '002632', '300045', '603966', '300141', '002203', '603767', '002172', '600235', '002295', '000021', '300387', '300063', '600660', '002441', '600373', '300390', '002475', '002121', '000969', '002083', '600206', '002733', '000518', '000782', '300249', '603358', '000088', '002866', '600058', '600638', '000973', '600855', '600153', '600152', '002270', '300333', '300470', '603901', '002386', '002373', '600884', '603717', '000858', '600068', '603229', '300337', '300402', '600797', '600259', '603416', '603708', '603839', '600309', '300293', '300101', '600331', '000686', '601881', '600048', '300528', '000544', '002780', '600684', '002597', '300538', '600773', '600675', '603288', '300572', '600997', '002521', '603929', '601388', '002407', '002235', '002093', '601518', '600536', '300181', '300140', '002446', '601952', '002167', '600270', '300456', '002177', '600808', '300006', '600977', '002696', '601688', '300484', '300600', '002648', '603628', '002361', '000036', '603656', '300256', '002873', '600081', '600074', '300154', '600360', '300426', '002424', '603818', '300570', '300586', '002162', '603991', '600185', '000011', '603038', '002501', '300235', '600237', '600231', '600571', '000652', '600784', '600531', '300541', '603886', '002802', '300374', '000156', '600619', '000089', '300412', '603977', '000540', '300177', '300636', '002583', '300668', '600078', '600686', '600399', '002445', '300171', '002430', '002857', '002360', '600085', '300443', '000521', '300020', '601811', '002709', '600192', '002042', '300346', '002320', '002820', '600831', '300081', '603139', '002428', '000630', '000528', '002626', '601229', '002859', '600476', '603035', '002825', '002826', '300506', '002432', '000418', '002708', '300605', '300003', '600501', '002808', '601898', '600780', '002800', '300573', '600190', '000049', '000815', '300599', '000925', '600917', '300034', '601555', '300286', '601009', '603987', '603888', '000014', '603703', '300539', '000553', '603177', '603586', '603881', '600069', '002594', '600138', '603833', '002027', '000609', '600269', '000780', '002860', '300247', '002229', '600410', '000655', '000850', '300153', '002313', '600803', '300660', '300328', '603188', '002040', '002657', '002584', '002803', '002797', '000962', '600658', '600741', '603101', '300273', '300589', '002416', '603768', '600348', '600628', '600963', '002165', '600792', '603303', '002002', '002529', '002850', '002663', '603819', '002182', '002433', '300542', '000839', '600403', '603787', '603663', '000800', '300295', '603008', '601699', '600626', '600109', '002801', '600888', '600499', '300625', '300508', '300369', '603585', '600070', '600163', '002540', '002716', '603518', '300658', '300583', '300548', '002805', '000910', '000733', '600650', '603936', '603669', '002114', '002243', '600982', '600031', '000837', '300553', '600418', '002405', '600007', '600433', '300611', '300199', '002266', '600973', '000911', '300179', '000833', '000801', '002630', '002634', '600695', '000698', '000963', '300417', '300353', '600805', '002758', '600508', '000546', '600297', '600368', '601166', '000731', '600063', '601216', '600770', '000603', '300363', '002474', '300378', '002771', '600819', '600575', '300529', '600242', '600213', '300150', '000012', '600091', '002649', '002073', '300463', '000010', '600836', '603007', '300489', '601918', '603398', '300442', '600019', '603559', '000006', '002363', '600400', '600580', '600220', '000563', '300196', '603031', '600866', '600775', '603577', '600276', '300348', '002183', '300457', '002123', '300623', '600624', '002393', '300010', '002029', '300046', '002593', '002063', '002401', '300048', '601111', '300617', '600249', '002329', '300130', '300424', '002274', '000937', '603843', '601888', '600789', '000025', '002091', '000636', '300139', '300156', '601127', '000552', '601969', '300394', '002380', '603798', '000987', '600157', '300218', '300195', '002048', '603218', '000058', '600848', '002746', '600865', '300095', '603626', '600892', '000529', '002666', '002298', '000632', '300015', '002875', '300569', '601311', '600718', '300399', '300435', '002612', '002852', '601006', '002495', '600177', '601366', '603606', '603508', '600864', '000739', '300428', '300630', '300300', '002215', '000587', '002396', '002074', '000417', '000818', '002110', '603811', '600623', '600692', '002169', '000514', '300455', '002269', '000551', '300250', '600697', '300547', '002369', '600683', '603393', '300555', '000897', '300120', '600386', '300482', '000423', '002601', '600668', '002404', '600282', '000151', '002817', '300229', '603928', '603909', '600555', '002551', '000712', '600169', '000702', '000069', '600569', '600525', '000790', '600396', '300137', '002728', '300549', '600778', '603908', '002035', '603999', '600674', '002374', '000737', '300290', '300080', '600729', '603020', '002178', '603385', '600275', '002195', '600679', '603980', '600006', '000886', '000426', '002346', '300517', '002062', '000570', '601933', '300038', '601375', '300238', '002304', '603421', '300380', '600077', '300211', '300639', '600629', '002137', '300445', '300561', '600648', '600699', '300243', '002145', '000532', '002435', '002046', '000905', '000900', '002245', '002620', '002077', '600378', '002032', '000917', '002790', '600598', '002702', '000572', '603239', '600458', '300379', '300165', '000960', '300657', '002518', '603189', '603569', '601997', '000968', '002055', '002125', '600561', '002395', '000635', '600763', '002191', '600649', '300642', '300067', '600022', '603380', '002645', '300405', '000812', '603208', '002253', '000736', '000400', '300098', '600319', '300602', '603309', '600850', '002848', '300339', '603002', '002553', '600096', '603096', '300062', '600315', '300161', '603817', '300258', '002633', '002150', '603039', '600230', '002713', '600875', '600621', '300439', '000564', '000856', '002321', '300415', '000750', '600877', '600681', '300239', '600635', '002097', '002308', '601139', '002192', '002099', '600887', '600311', '000056', '603268', '000825', '300312', '600696', '603789', '002760', '601333', '002043', '300105', '002793', '000639', '603199', '300049', '000565', '002375', '300475', '600219', '002118', '000715', '601169', '300214', '600141', '001979', '600436', '300191', '600720', '603519', '603318', '300391', '603322', '603900', '002065', '002164', '002639', '002301', '600467', '600317', '002792', '002829', '603690', '300427', '600526', '603859', '600064', '002776', '002865', '600363', '300029', '000753', '300446', '603090', '002227', '002453', '603889', '000040', '000718', '603266', '600327', '002398', '002862', '601668', '600446', '600159', '002653', '600736', '000826', '000625', '000601', '600197', '002673', '000059', '601238', '603066', '603919', '600520', '600352', '300393', '600143', '600690', '600328', '002502', '603186', '002287', '600704', '600030', '000531', '300410', '300200', '603959', '000789', '603166', '603699', '000078', '601908', '000930', '601188', '600838', '603388', '600551', '600201', '300358', '300383', '002556', '000421', '000685', '000988', '600210', '600507', '600186', '002379', '300425', '600128', '601377', '603167', '002624', '002024', '600060', '000816', '601015', '002507', '601998', '600428', '300495', '002667', '300587', '002562', '000892', '601163', '000920', '603838', '002487', '002154', '601599', '300382', '600782', '600338', '600576', '600012', '600026', '000070', '600094', '000607', '000779', '300535', '600470', '000803', '000037', '300377', '600243', '600182', '000573', '600647', '600969', '600107', '600366', '600891', '600106', '000005', '002237', '000993', '300635', '600592', '600870', '300170', '002836', '600502', '300056', '600059', '601038', '600883', '600266', '300042', '600233', '600843', '300226', '600287', '300064', '000792', '600880', '002052', '002749', '002745', '600037', '300051', '300307', '000761', '002144', '600714', '600131', '300253', '000786', '300144', '600688', '300468', '603698', '300240', '002535', '002349', '000729', '002022', '002408', '002740', '000581', '601777', '000637', '600390', '000663', '603903', '300106', '002770', '002467', '002397', '000586', '300551', '603589', '002406', '002204', '600312', '000415', '002500', '601226', '002225', '300070', '601677', '600860', '002095', '603630', '000068', '600325', '600272', '300082', '000713', '600039', '300360', '002328', '002166', '600611', '600500', '603986', '600689', '000776', '000721', '601901', '600256', '603688', '002615', '300366', '600677', '300351', '600388', '300503', '300487', '600203', '002838', '600377', '000830', '000683', '601368', '601010', '002674', '600401', '002454', '002038', '600633', '601008', '002036', '603689', '603300', '600712', '002478', '600756', '000620', '002087', '000777', '000657', '600661', '000616', '002213', '000598', '300523', '603520', '002652', '000757', '600355', '600785', '002528', '000158', '600295', '600874', '002811', '600200', '600166', '000863', '603001', '600095', '002561', '002337', '002772', '300079', '601567', '002823', '601186', '601218', '600533', '300584', '002849', '000828', '601788', '600791', '002867', '603968', '601339', '300645', '600726', '002219', '300406', '600757', '600207', '002339', '603203', '600354', '300123', '300173', '002440', '002463', '603015', '600248', '600202', '600616', '600509', '002677', '600815', '300326', '002533', '300287', '600359', '300411', '002490', '002443', '002527', '603779', '000407', '002310', '002359', '600180', '600292', '002700', '603058', '002646', '601107', '603108', '000596', '601966', '600724', '002520', '600088', '300512', '300460', '000622', '002623', '600787', '002005', '002338', '002184', '300297', '300314', '600995', '000597', '002489', '300320', '300242', '603899', '600584', '300246', '600426', '603887', '002734', '002100', '600198', '000628', '000811', '600119', '002299', '601789', '600105', '002718', '002314', '600557', '002249', '300174', '600232', '603033', '000338', '300251', '002795', '603005', '000667', '000513', '600532', '600665', '600020', '002324', '000429', '002613', '300522', '601200', '000554', '002383', '603885', '000732', '603800', '600279', '603898', '300002', '002672', '002214', '002750', '002233', '603996', '600703', '600117', '002272', '300365', '300147', '600817', '600029', '600809', '300485', '601929', '601899', '000767', '601886', '600118', '600234', '600835', '603117', '000796', '002459', '600299', '601882', '601002', '600320', '600779', '000939', '300282', '300032', '600667', '000977', '300078', '000419', '600682', '002357', '300321', '600825', '600114', '600306', '300318', '603123', '603588', '000936', '601900', '603333', '600488', '002661', '600822', '600748', '000868', '002731', '002251', '600000', '002538', '300110', '600613', '600746', '002014', '002305', '002181', '002026', '300168', '002822', '600240', '600589', '603883', '603878', '300302', '002016', '002221', '000783', '300039', '000707', '603528', '601798', '601179', '601016', '002319', '600640', '002133', '002206', '600601', '002134', '000516', '603339', '002334', '600379', '002140', '600062', '000999', '603037', '000031', '600376', '600033', '000425', '600873', '603727', '600617', '001696', '000898', '603225', '300262', '300187', '603366', '600824', '600408', '002660', '000955', '300007', '300068', '002778', '000869', '002217', '002603', '300336', '002434', '000520', '600510', '603568', '300114', '600818', '601818', '000726', '000650', '600958', '600448', '002686', '300069', '000957', '300155', '600810', '600475', '300132', '000931', '603939', '300017', '300585', '600846', '300511', '000820', '600535', '300119', '300027', '300166', '000972', '000876', '300059', '600845', '300175', '603726', '002815', '600313', '002763', '002276', '600268', '600241', '000042', '300131', '002422', '000561', '600381', '002060', '601005', '600597', '300483', '300086', '300469', '300237', '601228', '300193', '600588', '000547', '600222', '002573', '300076', '603806', '002436', '002438', '603988', '002208', '002541', '000709', '600179', '600861', '300126', '002117', '600086', '000919', '600811', '600802', '300303', '002578', '300260', '002707', '603558', '601369', '600397', '603979', '600010', '002798', '600708', '002483', '000961', '002477', '600739', '300204', '000806', '600208', '600293', '300305', '600548', '600456', '002041', '600854', '600218', '300231', '002352', '300527', '600168', '600310', '600135', '000027', '601991', '600990', '000903', '300491', '002413', '300160', '601199', '600919', '600015', '600420', '002244', '000402', '300627', '002205', '300499', '601117', '600223', '600732', '300090', '600807', '300012', '002572', '002791', '000517', '600283', '600495', '300194', '001896', '300433', '000498', '600894', '000980', '002831', '300343', '600993', '600889', '600618', '600833', '603222', '600073', '300431', '600415', '603609', '002515', '601579', '002565', '300283', '002662', '600823', '002618', '600257', '600512', '002394', '600837', '600160', '000952', '300558', '603639', '000065', '600744', '600101', '600216', '300604', '002470', '002494', '600246', '002156', '600489', '600747', '300285', '002347', '300054', '000875', '002755', '600511', '600052', '002115', '603138', '300452', '600587', '600881', '600089', '601222', '300526', '002687', '600513', '600606', '603556', '600698', '000524', '000585', '600716', '300159', '002003', '000539', '000821', '002727', '300494', '002004', '603158', '002303', '300005', '002736', '600558', '002159', '000927', '002580', '002400', '600481', '300025', '002782', '002519', '600828', '300310', '000411', '601666', '600129', '600284', '002514', '000416', '300465', '603896', '600016', '000890', '300520', '600326', '600302', '600184', '600405', '000929', '000877', '002821', '002579', '002549', '600971', '600035', '603990', '600565', '002344', '002779', '600498', '600463', '000166', '600422', '000589', '600999', '600705', '002066', '601258', '600530', '002732', '600735', '600731', '002575', '300595', '600769', '601118', '600979', '300121', '300575', '603006', '600307', '600382', '002367', '300581', '600970', '002574', '002210', '600148', '300329', '600898', '600335', '000096', '601880', '600130', '000902', '600814', '002768', '603100', '600570', '002317', '300143', '002300', '601700', '300004', '601106', '002683', '600273', '002116', '002429', '002069', '600853', '600678', '000880', '002752', '603788', '601126', '600642', '000420', '000001', '600988', '000735', '002187', '600583', '002031', '300223', '300354', '603198', '002286', '300397', '300471', '000681', '002421', '600051', '600332', '002839', '000623', '000401', '002277', '300125', '600425', '000835', '002690', '600261', '002692', '002377', '600449', '000998', '000691', '002071', '603319', '600262', '002292', '300272', '002186', '000668', '600486', '000971', '600303', '600727', '603088', '002355', '300072', '000985', '300448', '603228', '300516', '603718', '600483', '300040', '000035', '300509', '300362', '002018', '601208', '600333', '600126', '600487', '300118', '603179', '300530', '600162', '600604', '002637', '300327', '601866', '300129', '600461', '000882', '600493', '002094', '002389', '002498', '603116', '002414', '600084', '300217', '601968', '000922', '600523', '002587', '603028', '002566', '002224', '600156', '603701', '603686', '002202', '300111', '000018', '600123', '601007', '300057', '000895', '000951', '600196', '002737', '601985', '603021', '600280', '300058', '600886', '002706', '000045', '300208', '603866', '601611', '002135', '300281', '603566', '002741', '002109', '600662', '600543', '600608', '600885', '002019', '600605', '601519', '002552', '600766', '300202', '000725', '002102', '603578', '600717', '600834', '600743', '002563', '002743', '002640', '002315', '000975', '300444', '002332', '603958', '600055', '000976', '600987', '600278', '002207', '600858', '600578', '300490', '300338', '601996', '601390', '600637', '600108', '000791', '300180', '603517', '000593', '600761', '600120', '000157', '300304', '002564', '600723', '600962', '002239', '603118', '600301', '000541', '600380', '600097', '300649', '002644', '002482', '603027', '601616', '600385', '600967', '300026', '002607', '600090', '601003', '000949', '600721', '600528', '300389', '002155', '600027', '300254', '300473', '603029', '300210', '002132', '601021', '600801', '600876', '000966', '600868', '603308', '300370', '600862', '600771', '002064', '600978', '600155', '000848', '300157', '002843', '002496', '002384', '000883', '600537', '600322', '600187', '300332', '300215', '300342', '002033', '000428', '600121', '000719', '300395', '603025', '601000', '000550', '603306', '600722', '002323', '600300', '002190', '600983', '600023', '002296', '603011', '300052', '601100', '600122', '002559', '000785', '000680', '601018', '300567', '600236', '002293', '300352', '600343', '300066', '000690', '002697', '600545', '600812', '600267', '002546', '002548', '000926', '002392', '000509', '601328', '300497', '002678', '002258', '002279', '603399', '000996', '002283', '002242', '600217', '002385', '600173', '002531', '600093', '601877', '002689', '603040', '300292', '300488', '600281', '000778', '002570', '603227', '300316', '002775', '600893', '601801', '300257', '002089', '300164', '600781', '600167', '300093', '600011', '002437', '600323', '002281', '000802', '000055', '603766', '002595', '603808', '002591', '002262', '002170', '300190', '600644', '000711', '000676', '600594', '600150', '300577', '300071', '600960', '600719', '600199', '300107', '002469', '300169', '000723', '600622', '600599', '002522', '002371', '000537', '300028', '000760', '300008', '600139', '300480', '300043', '603315', '002327', '000046', '600738', '603128', '603022', '000913', '300277', '601718', '603658', '002275', '002267', '000039', '600821', '300206', '002084', '000983', '000906', '600702', '002832', '000798', '000672', '300084', '002627', '002456', '300220', '300055', '300436', '002411', '600004', '600178', '300099', '000505', '300044', '000679', '600515', '002581', '002297', '600645', '600614', '002450', '601808', '601515', '300133', '002149', '002598', '002090', '300476', '603168', '002086', '600620', '600829', '300265', '002681', '300216', '002107', '300464', '000567', '300138', '000566', '000062', '603043', '600209', '600680', '002714', '300385', '603997', '002845', '603355', '002222', '600926', '000938', '601231', '000703', '000756', '300616', '300392', '000590', '600389', '600421', '000576', '002112', '600053', '600804', '000669', '300557', '600826', '300437', '002111', '002158', '002841', '002544', '600298', '000004', '600391', '600547', '002174', '603861', '603677', '603616', '603608', '603599', '603598', '603501', '603369', '603299', '603238', '603131', '603126', '603099', '603078', '603032', '603016', '603010', '601999', '601992', '601989', '601988', '601919', '601872', '601717', '601633', '601618', '601608', '601588', '601558', '601313', '601288', '601233', '601128', '601099', '601088', '601069', '601058', '601028', '601001', '600985', '600959', '600890', '600871', '600863', '600844', '600795', '600794', '600790', '600774', '600768', '600764', '600759', '600734', '600733', '600725', '600715', '600707', '600701', '600691', '600673', '600671', '600666', '600657', '600655', '600654', '600653', '600643', '600636', '600634', '600615', '600609', '600603', '600600', '600590', '600579', '600577', '600568', '600559', '600556', '600550', '600539', '600538', '600522', '600490', '600485', '600468', '600462', '600460', '600439', '600429', '600423', '600375', '600369', '600358', '600353', '600318', '600290', '600289', '600277', '600255', '600252', '600239', '600227', '600221', '600193', '600172', '600170', '600165', '600149', '600146', '600145', '600136', '600127', '600115', '600100', '600098', '600083', '600079', '600075', '600067', '600050', '600028', '600017', '600009', '300676', '300675', '300612', '300603', '300582', '300543', '300518', '300510', '300500', '300492', '300486', '300478', '300466', '300462', '300461', '300459', '300440', '300423', '300422', '300420', '300414', '300413', '300404', '300388', '300364', '300340', '300325', '300322', '300313', '300308', '300298', '300291', '300278', '300276', '300268', '300267', '300252', '300234', '300230', '300219', '300209', '300201', '300198', '300192', '300189', '300185', '300183', '300178', '300163', '300152', '300151', '300149', '300148', '300145', '300134', '300109', '300108', '300104', '300103', '300100', '300092', '300089', '300088', '300087', '300085', '300075', '300065', '300030', '300022', '002856', '002819', '002806', '002796', '002788', '002787', '002781', '002777', '002766', '002757', '002756', '002739', '002729', '002711', '002694', '002693', '002684', '002676', '002675', '002669', '002654', '002650', '002647', '002642', '002641', '002638', '002625', '002622', '002621', '002619', '002616', '002610', '002606', '002600', '002599', '002596', '002588', '002586', '002582', '002576', '002569', '002567', '002554', '002547', '002523', '002516', '002513', '002509', '002506', '002505', '002504', '002499', '002486', '002481', '002473', '002468', '002464', '002449', '002447', '002442', '002427', '002426', '002425', '002420', '002418', '002417', '002409', '002399', '002391', '002388', '002381', '002358', '002356', '002350', '002348', '002331', '002312', '002288', '002280', '002264', '002263', '002260', '002256', '002255', '002252', '002248', '002218', '002175', '002168', '002157', '002152', '002143', '002141', '002130', '002129', '002128', '002127', '002122', '002098', '002076', '002075', '002070', '002058', '002053', '002049', '002030', '002015', '002013', '002012', '002006', '002001', '000979', '000967', '000958', '000953', '000935', '000932', '000889', '000887', '000885', '000862', '000838', '000836', '000822', '000809', '000766', '000755', '000727', '000720', '000716', '000700', '000693', '000682', '000678', '000673', '000662', '000633', '000613', '000610', '000606', '000571', '000559', '000557', '000555', '000543', '000536', '000534', '000519', '000511', '000506', '000503', '000409', '000403', '000301', '000159', '000153', '000100', '000099', '000061', '000038', '000034', '000032', '000030', '000029', '000020', '000007', '002818', '002151', '603918', '600593', '600897', '002230', '603828', '002051', '000697', '300284', '300269', '601098', '603017', '002200', '600316', '600859', '002589', '002724', '000526', '600765', '603998', '002198', '600857', '002742', '002608', '603778', '600585', '300274', '002231', '000043', '000788', '002345', '002096', '002451', '000430', '300355', '000705', '300019', '300122', '601766', '000793', '002493', '000981', '000989', '300031', '600882', '000978', '002685', '300288', '000759', '600976', '600685', '002124', '300345', '002216', '002390', '601198', '000908', '600506', '600730', '300117', '002851', '300011', '601566', '600827', '601669', '600517', '600602', '002585', '603601', '002617', '300227', '601158', '002665', '603328', '603320', '603869', '603678', '600455', '300233', '600572', '603197', '000995', '600869', '603737', '603822', '002807', '300296', '300041', '002265', '002343', '002457', '600361', '600371', '002119', '600664', '000671', '600215', '600038', '002671', '002290', '002659', '002081', '002765', '002353', '600225', '600754', '300135', '000591', '603777', '603067', '002023', '000050', '603003', '600841', '603969', '002246', '600820', '002721', '600238', '002651', '300014', '000738', '002333', '601928', '600435', '002725', '600496', '300275', '002138', '002751', '002120', '002326', '002228', '000768', '000619', '600340', '600737', '600562', '603019', '300501', '002364', '600639', '300279', '002524', '300613', '300188', '300255', '000560', '002511', '600896', '002532', '600365', '600596', '600895', '600151', '002723', '603636', '603858', '002020', '000860', '002668', '601857', '002223', '002747', '600984', '000918', '600777', '000582', '002526', '002410', '000608', '000008', '000959', '600518', '300441', '002557', '002354', '300349', '000799', '603223', '002273', '603729', '600171', '600080', '002342', '002259', '002735', '002282', '000408', '600072', '600054', '600416', '002131', '002059', '600212', '600189', '600339', '600693', '002558', '300453', '600195', '002336', '601939', '002560', '000422', '600749', '002679', '601890', '603098', '300498', '601012', '000017', '600879', '600505', '600540', '300001', '300259', '601113', '300315', '002682', '300021', '603716', '300236', '601398', '300172', '002188', '002387', '002146', '002080', '603313', '600529', '002643', '002705', '002762', '000523', '002571', '002088', '000677', '002189', '600393', '300061', '000881', '002785', '000990', '600758', '300610', '300396', '603615', '600965', '300481', '600008', '000631', '300341', '603258', '000829', '600908', '600491', '600387', '603679', '000026', '002786', '300036', '000600', '002316', '600021', '002461', '002238', '002028', '603326', '601727', '002201', '600229', '300384', '300429', '300335', '600745', '000852', '000533', '300371', '002370', '300241', '002699', '000893', '000670', '002045', '002185', '300222', '600466', '600527', '600847', '002503', '002163', '000605', '300373', '601211', '300601', '600137', '002247', '300167', '002072', '300299', '002173', '000595', '603579', '002431', '600687', '603160', '002285', '002789', '000659', '000888', '601799', '603989', '600061', '300344', '300381', '600211', '002846', '603111', '603165', '002539', '002254', '000048', '002085', '600663', '002688', '002322', '002372', '603368', '002670', '300016', '600478', '000813', '300221', '600099', '002376', '002351', '000797', '300113', '300096', '600469', '600851', '600992', '300124', '300367', '603030', '600760', '601116', '002153', '002629', '000923', '002840', '600651', '000819', '600438', '000695', '002828', '002147', '002476', '300513', '300560', '002542', '002103', '600444', '600975', '000504', '002365', '002517', '300203', '002180', '002423', '600479', '300266', '300182', '600066', '002611', '002767', '600116', '002330', '600372', '300232', '002656', '000525', '300264', '603012', '000558', '600329', '002011', '601155', '600250', '603429', '000626', '000722', '000592', '600305', '600057', '600641', '603603', '300472', '002047', '002602', '300009', '600247', '603323', '300376', '600867', '002722', '600228', '002278', '000823', '002701', '600706', '002485', '002306', '600750', '000965', '002592', '000859', '002335', '300418', '300458', '000611', '600482', '300505', '603377', '002880', '002113', '300467', '601177', '002325', '600900', '300146', '002568', '300407', '002472', '002366', '000915', '000997', '002010', '002761', '002809', '300350', '300347', '600018', '300033', '300225', '002220', '600337', '300289', '002769', '002680', '600419', '002289', '603515', '000810', '603336', '002199', '002462', '002021', '300519', '300334', '600793', '300507', '600285', '300408', '600112', '002605', '603023', '600652', '600755', '603338', '600610', '002726', '300271', '300628', '300263', '600546', '300294', '600271', '603444', '000982', '002025', '600161', '300545', '300521', '600158', '600370', '002658', '000656', '300324', '002007', '601326', '600806', '600710', '600432', '300678', '300677', '300673', '300672', '300372', '002888', '002887', '002884', '002882', '002879', '000950', '000629', '000155', '603933', '603757', '603730', '603707', '603612', '603595', '603387', '603305', '601619']
        # self._temp_stock_pool=self._temp_stock_pool[:600]
        # self._temp_stock_pool=[i for i in self._temp_stock_pool if i[:1]=='6']
        self._temp_stock_pool=self._temp_stock_pool[:1000]
        self.buypool=[]
        self.sellpool=[]
        n=200
        string=today #'2016-07-12'
        today_list=string.split('-')
        year=int(today_list[0])
        month=int(today_list[1])
        day=int(today_list[2])
        today_datetime=datetime.datetime(year, month, day)
        today=today_datetime.strftime('%Y-%m-%d')
        # print('today',today)
        self._pre_trade_day=(today_datetime - datetime.timedelta(days=1)).strftime('%Y-%m-%d')
        # print('self._pre_trade_day',self._pre_trade_day)
        self._n_days_before=(today_datetime - datetime.timedelta(days=n)).strftime('%Y-%m-%d')
        # print('self._n_days_before',self._n_days_before)
        
        
        
        
    def _get_stock_data(self,stock_code):
        n=200
        data_length=100
        today=datetime.date.today().strftime('%Y-%m-%d')
        pre_trade_day=(datetime.datetime.now() - datetime.timedelta(days=1)).strftime('%Y-%m-%d')
        n_days_before=(datetime.datetime.now() - datetime.timedelta(days=n)).strftime('%Y-%m-%d')
        stock_data=ts.get_k_data(str(stock_code),start=self._n_days_before,end=self._pre_trade_day).tail(data_length)
        return stock_data
        
        
    def _stock_in_which_market(self,stock_code):
        上证A股=[i for i in self._temp_stock_pool if i[:3]=='600' or  i[:3]=='601' or  i[:3]=='603' or i[:4]=='6016' ] 
        深证A股市=[i for i in self._temp_stock_pool if i[:3]=='000' or i[:3]=='001' ]
        深圳创业板=[i for i in self._temp_stock_pool if i[:3]=='300']
        深圳中小板=[i for i in self._temp_stock_pool if i[:3]=='002']
        i = str(stock_code)
        if i in 上证A股:
            return '000002','上证A股'
        elif i in 深证A股市:
            return '399107','深证A股市'
        elif i in 深圳创业板:
            return '399006','深圳创业板'
        elif i in 深圳中小板:
            return '399005','深圳中小板'
        else:
            return '399006','unknown'
        
    def _get_correspond_index_data(self,stock_code):
        data_length=100
        n=200
        today=datetime.date.today().strftime('%Y-%m-%d')
        pre_trade_day=(datetime.datetime.now() - datetime.timedelta(days=1)).strftime('%Y-%m-%d')
        n_days_before=(datetime.datetime.now() - datetime.timedelta(days=n)).strftime('%Y-%m-%d')
        index_market,_=self._stock_in_which_market(str(stock_code))
        return ts.get_k_data(index_market,index=True,start=self._n_days_before,end=self._pre_trade_day)[['date','close']].tail(data_length)
        
    def _T_or_F(self,stock_code):

        try:
            stock_data=self._get_stock_data(stock_code)
        except:
#             print('{:-^}'.format(1))
            return False,False
        
        if len(stock_data)<40:
#             print('{:-^}'.format(2))
            return False,False
        try:
        
            A个股收盘=stock_data[['date','close']].ewm(span=30,adjust=False,min_periods=30).mean()
            A个股上限=A个股收盘.ewm(span=7,min_periods=7,adjust=False).mean()
            x=stock_data[['date','close']].set_index('date')
            y=A个股上限.set_index('date')
            A个股趋势=100*((x / y))  

            A大盘收盘=self._get_correspond_index_data(stock_code).ewm(span=49,min_periods=49,adjust=False).mean()
            A大盘上限=A大盘收盘.ewm(span=7,min_periods=7,adjust=False).mean()
            index_x=A大盘收盘.set_index('date')
            index_y=A大盘上限.set_index('date')
            A大盘趋势=100*(index_x/index_y)

            筹码主动率=100*(A个股趋势 - A大盘趋势)/A大盘趋势
            筹码主动率=筹码主动率.dropna()

            #   最后3天总有一天（<0.8） and  连续三1次上涨 (>0) ，and，最后一天大于1  （ >2.3）
            buy_threshold=3
            buy_condi=(筹码主动率.tail(3)<0.8).values.any()  and (筹码主动率.tail(2).diff().dropna()>0).all()[0] and (筹码主动率.tail(1)>buy_threshold).all()[0]  and (筹码主动率.tail(1)>buy_threshold).all()[0] 

            # 最后2天总有一天（>1）  and  连续1次下跌 (<0) ，并且，最后一天小于1  （ <1）
            sell_threshold=0.8
            sell_condi=(筹码主动率.tail(2)>1).values.any()  and (筹码主动率.tail(2).diff().dropna()<0).all()[0] and (筹码主动率.tail(1)<sell_threshold).all()[0]
#             print('{:-^}'.format(3))
            return buy_condi,sell_condi
        except Exception as e:
#             print('{:-^60}'.format(4))
            print ( e ) 
            
            return False,False
        
    def _get_buysell_pool(self):
        buyit=[]
        sellit=[]
        for i in self._temp_stock_pool:
            temp=self._T_or_F(i)
            buyit.append( temp[0] )
            sellit.append( temp[1]  )
#         self.buypool=buyit
#         self.sellpool=sellit
        self.buypool=[stock_id for stock_id,buy in zip(self._temp_stock_pool,buyit) if buy ==True ]
        self.sellpool=[stock_id for stock_id,sell in zip(self._temp_stock_pool,sellit) if sell ==True ]
        
        
    def get_pool(self):
        pool = ThreadPool(30)
        results = pool.map(self._T_or_F, self._temp_stock_pool)
        pool.close() 
        pool.join() 
        results_wanted=[i for i in  results ]
        buyit=[]
        sellit=[]
        for i in results_wanted:

            buyit.append( i[0] )
            sellit.append( i[1]  )
#         self.buypool=buyit
#         self.sellpool=sellit
#         print('any(sellit)',any(sellit))
#         print('len(sellit)',len(sellit) )
        self.buypool=[stock_id for stock_id,buy in zip(self._temp_stock_pool,buyit) if buy   ]
        self.sellpool=[stock_id for stock_id,sell in zip(self._temp_stock_pool,sellit) if sell  ]











# 在这个方法中编写任何的初始化逻辑。context对象将会在你的算法策略的任何方法之间做传递。
def init(context):
    # 在context中保存全局变量
    # context.s1='300116.XSHE'
    
    
    # context.benchmark="300131.XSHE"
    context.buypool = []
    context.sellpool = []
    # 实时打印日志
    logger.info("RunInfo: {}".format(context.run_info))
    
    # scheduler.run_daily(handle_bar, time_rule=market_open(minute=40))
    scheduler.run_daily(handle_bar, time_rule=market_open(minute=50))
    
    

# before_trading此函数会在每天策略交易开始前被调用，当天只会被调用一次
def before_trading(context):
    def convert_stock_code(stock_list):
        return [  i+'.XSHG' if i[:1]=='6' else   i+'.XSHE'  for i in  stock_list ]
    
    today=context.now.strftime('%Y-%m-%d')
    
    s=MarketEma(today)
    s.get_pool()
    context.buypool=convert_stock_code(s.buypool)
    context.sellpool = convert_stock_code(s.sellpool)
    
    # # print('{:-^80}'.format(today))
    # print('{}'.format(today))
    # # logger.info("RunInfo: {}".format( today ))
    # print("{:-^80}".format(444))
    print("{:-^80}".format(today))
    # logger.info(today)
    
################buy##############################    
    
    logger.info('context.buypool')
    
    stock_list_in_account=[stock_id for stock_id in context.portfolio.positions.keys()]
    N_stocks=5
    if len(stock_list_in_account)<N_stocks:
        context.buypool=context.buypool[:(N_stocks-len(stock_list_in_account))]
        for i in context.buypool:
            print(i)
    else:
        context.buypool=[]
##############################################        
    context.stock_to_sell=[stock_id for stock_id in context.portfolio.positions.keys()  if stock_id in context.sellpool ]
    print('context.stock_to_sell')
    for stock_id in context.stock_to_sell:
        print(stock_id)    
    # pass


# 你选择的证券的数据更新将会触发此段逻辑，例如日或分钟历史数据切片或者是实时数据切片更新
def handle_bar(context, bar_dict):
    # 开始编写你的主要的算法逻辑

    # bar_dict[order_book_id] 可以拿到某个证券的bar信息
    # context.portfolio 可以拿到现在的投资组合信息

    # 使用order_shares(id_or_ins, amount)方法进行落单

    # TODO: 开始编写你的算法吧！
    try:
        order_pct=1/len(context.buypool)
    except:
        order_pct=0
        
    order_pct=min(0.1,order_pct)

    #to buy all context.buypool    
    
    

    
    for stock_id in context.buypool:
        order_target_percent(stock_id,order_pct)
        
    #to sell all context.sellpool
   
    # logger.info('context.sellpool')


    
    
    for stock_id in context.stock_to_sell:
        # print(stock_id)
        order_target_percent(stock_id,0)

    # for stock_id in context.sellpool:
    #     order_target_percent(stock_id,0)

# after_trading函数会在每天交易结束后被调用，当天只会被调用一次
def after_trading(context):
    pass






